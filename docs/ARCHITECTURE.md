# Render2Go 项目架构

## 概述

Render2Go 是一个模块化的数学动画渲染框架，采用分层架构设计，易于扩展和维护。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户接口层                           │
├─────────────────────────────────────────────────────────┤
│  cmd/render2go/main.go  │  交互式命令行  │  脚本执行器  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    解释器层                             │
├─────────────────────────────────────────────────────────┤
│  Lexer词法分析  │  Parser语法分析  │  Evaluator执行引擎  │
│  interpreter.go │      ast.go     │   evaluator.go    │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    业务逻辑层                           │
├─────────────────────────────────────────────────────────┤
│  Scene场景  │  Animation动画  │  Geometry几何  │ Core核心│
│  scene.go   │  animation.go   │  shapes.go    │mobject.go│
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    基础设施层                           │
├─────────────────────────────────────────────────────────┤
│  Renderer渲染  │  Math数学库  │  Colors色彩  │  文件I/O  │
│  renderer.go   │  vector.go   │  colors.go  │   输出    │
└─────────────────────────────────────────────────────────┘
```

## 模块详细说明

### 1. 用户接口层 (cmd/)

#### cmd/render2go/main.go
- **职责**: 程序入口点，命令行参数解析
- **功能**: 
  - 解析命令行参数 (-debug, -interactive, -clean等)
  - 初始化解释器
  - 处理不同执行模式

### 2. 解释器层 (interpreter/)

#### interpreter.go - 主解释器
- **职责**: 脚本解释和执行协调
- **功能**:
  - 文件读取和脚本执行
  - 错误处理和调试信息
  - PNG文件扩展名自动修复

#### lexer.go - 词法分析器
- **职责**: 将脚本文本转换为Token流
- **支持的Token类型**:
  - 关键字: `scene`, `create`, `set`, `animate`, `save`
  - 操作符: `=`, `+`, `-`, `*`, `/`
  - 标识符和字面量: 数字、字符串、坐标

#### parser.go - 语法分析器
- **职责**: 将Token流转换为抽象语法树(AST)
- **支持的语句类型**:
  - SceneStatement: 场景设置
  - CreateStatement: 对象创建
  - SetStatement: 属性设置
  - AnimateStatement: 动画定义
  - SaveStatement: 文件保存

#### evaluator.go - 执行引擎
- **职责**: 执行AST，调用底层API
- **功能**:
  - 对象生命周期管理
  - 属性设置和动画执行
  - 文件输出和错误处理

### 3. 业务逻辑层

#### scene/scene.go - 场景管理
- **职责**: 管理渲染场景和对象集合
- **功能**:
  - 场景尺寸和坐标系统
  - 对象添加、删除、查找
  - 渲染管道控制

#### animation/animation.go - 动画系统
- **职责**: 动画效果和时间控制
- **支持的动画类型**:
  - 位置动画 (MoveTo, Shift)
  - 颜色渐变
  - 透明度变化
  - 缩放和旋转

#### geometry/shapes.go - 几何图形
- **职责**: 基本几何图形定义
- **支持的图形**:
  - Circle: 圆形
  - Triangle: 三角形  
  - Rectangle: 矩形
  - Line: 线段
  - Text: 文本

#### core/mobject.go - 核心对象模型
- **职责**: 定义可动画对象的基础接口
- **核心接口**:
  - Mobject: 所有可动画对象的基类
  - BaseMobject: 基础实现
  - 变换方法: MoveTo, Scale, Rotate

### 4. 基础设施层

#### renderer/renderer.go - 渲染引擎
- **职责**: 图形渲染和文件输出
- **功能**:
  - 2D图形绘制 (基于gg库)
  - PNG文件生成
  - 自动保存和扩展名处理

#### math/vector.go - 数学库
- **职责**: 数学计算和坐标变换
- **功能**:
  - Vector2: 二维向量
  - CoordinateSystem: 坐标系统
  - 几何变换计算

#### colors/colors.go - 色彩系统
- **职责**: 颜色管理和配色方案
- **功能**:
  - 十六进制颜色解析
  - 预定义配色方案
  - 颜色插值和渐变

## 数据流向

```
脚本文件(.r2g)
    ↓
Lexer (词法分析)
    ↓
Token流
    ↓
Parser (语法分析)
    ↓
AST (抽象语法树)
    ↓
Evaluator (执行引擎)
    ↓
Scene/Animation/Geometry (业务逻辑)
    ↓
Renderer (渲染引擎)
    ↓
PNG文件输出
```

## 设计模式

### 1. 解释器模式 (Interpreter Pattern)
- 用于脚本语言的解析和执行
- 每种语句类型对应一个解释器

### 2. 策略模式 (Strategy Pattern)
- 动画类型的不同实现
- 几何图形的多态渲染

### 3. 工厂模式 (Factory Pattern)
- 几何对象的创建
- Token和AST节点的生成

### 4. 观察者模式 (Observer Pattern)
- 动画状态变化通知
- 渲染刷新机制

## 扩展点

### 1. 新增几何图形
在 `geometry/shapes.go` 中：
```go
type NewShape struct {
    BaseMobject
    // 新图形特有属性
}

func (s *NewShape) Draw(ctx *renderer.Context) {
    // 绘制逻辑
}
```

### 2. 新增动画类型
在 `animation/animation.go` 中：
```go
type NewAnimation struct {
    BaseAnimation
    // 动画特有属性
}

func (a *NewAnimation) Apply(obj Mobject, t float64) {
    // 动画应用逻辑
}
```

### 3. 新增语法特性
1. 在 `lexer.go` 中添加新Token类型
2. 在 `parser.go` 中添加语法规则
3. 在 `evaluator.go` 中添加执行逻辑

## 依赖关系

```
cmd/render2go
    ↓
interpreter
    ↓
scene ← animation ← geometry ← core
    ↓           ↓        ↓
renderer ← math ← colors
```

## 性能考虑

### 1. 内存管理
- 对象池复用几何图形
- 及时释放大型图像资源
- 避免深度递归调用

### 2. 渲染优化
- 脏矩形更新机制
- 图层分离渲染
- 纹理缓存复用

### 3. 文件I/O优化
- 批量文件操作
- 异步文件写入
- 压缩算法选择

## 错误处理策略

### 1. 分层错误处理
- 解释器层：语法错误、语义错误
- 业务层：逻辑错误、参数验证
- 基础层：系统错误、I/O错误

### 2. 错误恢复机制
- 语法错误：跳过错误语句继续解析
- 运行时错误：记录错误但不中断执行
- 致命错误：立即终止并报告

### 3. 调试支持
- 详细的错误位置信息 (文件名:行号)
- 调试模式下的执行跟踪
- AST可视化输出

## 测试策略

### 1. 单元测试
- 每个模块的独立测试
- Mock对象模拟依赖

### 2. 集成测试
- 端到端脚本执行测试
- 渲染结果验证

### 3. 性能测试
- 大场景渲染性能
- 内存使用情况监控

---

*本架构文档随项目发展持续更新*
